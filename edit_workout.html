<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ویرایش فعالیت</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <video id="activity-video" autoplay muted loop style="width: 100%; max-width: 600px; margin-bottom: 20px; display: none;">
            <source id="activity-video-source" type="video/mp4">
            مرورگر شما از تگ ویدیو پشتیبانی نمی‌کند.
        </video> 
        <div class="tooltip-container">
            <span id="info-icon" class="info-icon">ℹ️</span>
            <div id="tooltip" class="tooltip">توضیحات تمرین ورزشی</div>
        </div>
        <form class="activity-form" id="activity-form">
            <label for="activity">نام فعالیت:</label>
            <input type="text" id="activity" name="activity" list="activity-list" oninput="updateVideo(); updateTooltip();">
            <datalist id="activity-list"></datalist>
            
            <label for="reps">تعداد حرکت:</label>
            <input type="number" id="reps" name="reps">
            
            <label for="sets">تعداد ست:</label>
            <input type="number" id="sets" name="sets">
            
            <label for="weight">کیلوگرم:</label>
            <input type="number" id="weight" name="weight">
        </form>
        <div class="button-row">
            <button type="submit" form="activity-form" onclick="saveActivity(event)">ذخیره</button>
            <button type="button" onclick="goBack()">انصراف</button>
            <button type="button" onclick="deleteActivity()">حذف</button>
        </div>
    </div>
    <script>
        let activitiesData = [];

        fetch('alldata.json')
            .then(response => response.json())
            .then(data => {
                activitiesData = data.Sheet1;
                const activityList = document.getElementById('activity-list');
                activitiesData.forEach(activity => {
                    const option = document.createElement('option');
                    option.value = activity.text;
                    activityList.appendChild(option);
                });
                // Update video and tooltip if activity is already set
                updateVideo();
                updateTooltip();
            });

        document.addEventListener('DOMContentLoaded', () => {
            const day = new URLSearchParams(window.location.search).get('day');
            const index = new URLSearchParams(window.location.search).get('index');
            if (index !== null) {
                const activities = JSON.parse(localStorage.getItem(day)) || [];
                const activity = activities[index].split(' - ');
                document.getElementById('activity').value = activity[1];
                document.getElementById('reps').value = activity[2].split(' ')[0];
                document.getElementById('sets').value = activity[3].split(' ')[0];
                document.getElementById('weight').value = activity[4].split(' ')[0];
                updateVideo();
                updateTooltip();
            }
        });

        function updateVideo() {
            const activityName = document.getElementById('activity').value;
            const activity = activitiesData.find(a => a.text === activityName);
            const videoElement = document.getElementById('activity-video');
            const videoSource = document.getElementById('activity-video-source');
            if (activity && activity.vid) {
                videoSource.src = activity.vid;
                videoElement.style.display = 'block';
                videoElement.load();
            } else {
                videoElement.style.display = 'none';
            }
        }

        function updateTooltip() {
            const activityName = document.getElementById('activity').value;
            const activity = activitiesData.find(a => a.text === activityName);
            const tooltip = document.getElementById('tooltip');
            if (activity && activity.info) {
                tooltip.textContent = activity.info;
            } else {
                tooltip.textContent = 'توضیحات تمرین ورزشی';
            }
        }

        function saveActivity(event) {
            event.preventDefault();
            const activity = document.getElementById('activity').value;
            const reps = document.getElementById('reps').value;
            const sets = document.getElementById('sets').value;
            const weight = document.getElementById('weight').value;

            if (!activity) {
                alert('لطفا نام فعالیت را وارد کنید');
                return;
            }

            const day = new URLSearchParams(window.location.search).get('day');
            const index = new URLSearchParams(window.location.search).get('index');
            const activities = JSON.parse(localStorage.getItem(day)) || [];
            const checked = index !== null ? activities[index].split(' - ')[0] : 'false';
            const activityText = `${checked} - ${activity} - ${reps} حرکت - ${sets} ست - ${weight} کیلوگرم`;

            if (index !== null) {
                activities[index] = activityText;
            } else {
                activities.push(activityText);
            }

            localStorage.setItem(day, JSON.stringify(activities));
            sessionStorage.setItem('updated', 'true');
            goBack();
        }

        function deleteActivity() {
            const day = new URLSearchParams(window.location.search).get('day');
            const index = new URLSearchParams(window.location.search).get('index');
            const activities = JSON.parse(localStorage.getItem(day)) || [];

            if (index !== null) {
                activities.splice(index, 1);
                localStorage.setItem(day, JSON.stringify(activities));
            }

            sessionStorage.setItem('updated', 'true');
            goBack();
        }

        function goBack() {
            const day = new URLSearchParams(window.location.search).get('day');
            window.location.href = `${day}.html`;
        }

        document.getElementById('activity').addEventListener('input', () => {
            updateVideo();
            updateTooltip();
        });

        // Tooltip functionality
        const infoIcon = document.getElementById('info-icon');
        const tooltip = document.getElementById('tooltip');

        infoIcon.addEventListener('mouseover', () => {
            tooltip.style.opacity = 1;
            tooltip.style.visibility = 'visible';
        });

        infoIcon.addEventListener('mouseout', () => {
            tooltip.style.opacity = 0;
            tooltip.style.visibility = 'hidden';
        });

        infoIcon.addEventListener('click', () => {
            tooltip.style.opacity = tooltip.style.opacity == 1 ? 0 : 1;
            tooltip.style.visibility = tooltip.style.visibility == 'visible' ? 'hidden' : 'visible';
        });

        document.addEventListener('click', (event) => {
            if (!infoIcon.contains(event.target) && !tooltip.contains(event.target)) {
                tooltip.style.opacity = 0;
                tooltip.style.visibility = 'hidden';
            }
        });
    </script>
</body>
</html>